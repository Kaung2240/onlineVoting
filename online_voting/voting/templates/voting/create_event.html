{% extends 'voting/base.html' %}

{% block title %}Create Event{% endblock %}

{% block content %}
<h2>Create New Event</h2>
<form method="post" enctype="multipart/form-data">
    <div id="event_form">
        {% csrf_token %}
        {{ event_form.as_p }}
    </div>
    <h3>Candidates</h3>
    {{ candidate_formset.management_form }}
    <div id="candidate-container">
        <!-- Reusable candidate form input -->
        <div id="candidate-input-form">
            <div class="candidate-form">
                {{ candidate_formset.empty_form.as_p }}
            </div>
        </div>
        <!-- Preview Container for Candidate -->
        <div id="candidate-preview">
            <p><strong>Preview:</strong></p>
            <p>Name: <span class="preview-name"></span></p>
            <p>Description: <span class="preview-description"></span></p>
            <p>Profile Picture: <img class="preview-image" alt="No image" style="max-width: 100px; max-height: 100px;"></p>
        </div>
    </div>
    <button type="button" id="add" class="btn btn-secondary">Add Candidate</button>
    <button type="submit" class="btn btn-primary">Save Event</button>
</form>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const candidateForms = document.getElementById('candidate-container');
        const totalForms = document.getElementById('id_form-TOTAL_FORMS');
        const addButton = document.getElementById('add');
        const maxFormsInput = document.getElementById('id_candidate_numbers');
        let maxForms = parseInt(maxFormsInput.value || '2', 10);

        maxFormsInput.addEventListener('change', function() {
            let value = parseInt(maxFormsInput.value, 10);
            if (isNaN(value) || value < 2) {
                alert('The number of candidates must be at least 2.');
                maxFormsInput.value = '';
                return;
            }
            maxForms = value;
        });

        addButton.addEventListener('click', function() {
            const currentFormCount = parseInt(totalForms.value);

            if (currentFormCount < maxForms) {
                const newForm = document.createElement('div');
                newForm.classList.add('candidate-form');
                newForm.innerHTML = document.getElementById('candidate-input-form').innerHTML;

                const formRegex = /__prefix__/g;
                newForm.innerHTML = newForm.innerHTML.replace(formRegex, currentFormCount);

                candidateForms.insertBefore(newForm, candidateForms.lastElementChild);
                totalForms.value = currentFormCount + 1;

                // Reattach preview listeners to the new form
                addPreviewListeners(newForm);
            } else {
                alert(`You can only add up to ${maxForms} candidates.`);
            }
        });

        function addPreviewListeners(candidateForm) {
            let nameInput = candidateForm.querySelector('input[name$="name"]');
            let descriptionInput = candidateForm.querySelector('textarea[name$="description"]');
            let profilePicInput = candidateForm.querySelector('input[name$="profile_pic"]');
            let previewName = candidateForms.querySelector('.preview-name');
            let previewDescription = candidateForms.querySelector('.preview-description');
            let previewImage = candidateForms.querySelector('.preview-image');

            nameInput.addEventListener('input', function() {
                previewName.textContent = nameInput.value;
            });

            descriptionInput.addEventListener('input', function() {
                previewDescription.textContent = descriptionInput.value;
            });

            profilePicInput.addEventListener('change', function() {
                let file = profilePicInput.files[0];
                if (file) {
                    let reader = new FileReader();
                    reader.onload = function(e) {
                        previewImage.src = e.target.result;
                    }
                    reader.readAsDataURL(file);
                } else {
                    previewImage.src = '';
                }
            });
        }

        // Initialize previews for existing formsets on page load
        addPreviewListeners(document.querySelector('#candidate-input-form .candidate-form'));
    });
</script>
{% endblock %}

{% block styles %}
<style>
    #candidate-container {
        display: flex;
        gap: 20px; /* Space between form and preview */
    }
    .candidate-form, #candidate-preview {
        flex: 1; /* Take equal space */
    }
    #candidate-preview {
        border: 1px solid #ddd;
        padding: 10px;
    }
</style>
{% endblock %}
